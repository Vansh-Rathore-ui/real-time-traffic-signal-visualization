import folium  # For creating interactive maps
import requests  # For making API requests
from geopy.geocoders import Nominatim  # For converting city names to coordinates
import webbrowser  # For opening the map in the default web browser

# ğŸ”‘ Your TomTom API Key
API_KEY = "DBPHgZWrTgLq1tusTJVfo3cbflAdanni"

# ğŸ” Get traffic light positions from OpenStreetMap using Overpass API
def get_traffic_light_nodes(lat, lon, radius=2000):
    overpass_url = "http://overpass-api.de/api/interpreter"
    query = f"""
    [out:json];
    node
      ["highway"="traffic_signals"]
      (around:{radius},{lat},{lon});
    out;
    """
    response = requests.get(overpass_url, params={'data': query})
    if response.status_code == 200:
        data = response.json()
        return [(el['lat'], el['lon']) for el in data['elements']]  # Return list of (lat, lon)
    else:
        print("âŒ Overpass API error:", response.status_code)
        return []

# ğŸ”„ Get traffic flow data from TomTom Traffic API
def get_traffic_flow(lat, lng):
    url = "https://api.tomtom.com/traffic/services/4/flowSegmentData/absolute/10/json"
    params = {
        "point": f"{lat},{lng}",  # Location of the traffic light
        "unit": "KMPH",           # Speed unit
        "key": API_KEY            # API authentication
    }
    response = requests.get(url, params=params)
    if response.status_code == 200:
        data = response.json().get("flowSegmentData", {})
        current_speed = data.get("currentSpeed", 0)
        free_flow_speed = data.get("freeFlowSpeed", 1)
        congestion = current_speed / free_flow_speed if free_flow_speed else 0  # Avoid division by zero
        return current_speed, free_flow_speed, congestion
    else:
        print(f"âŒ Traffic API error at {lat}, {lng}")
        return None, None, None

# ğŸš¦ Determine traffic light color based on congestion level
def get_light_status(congestion):
    if congestion > 0.8:
        return "ğŸ”´ Red - Stop", "red"
    elif congestion > 0.5:
        return "ğŸŸ¡ Yellow - Slow", "yellow"
    else:
        return "ğŸŸ¢ Green - Go", "green"


# ğŸ—ºï¸ Generate map with real traffic lights and traffic conditions
def create_real_traffic_light_map(city):
    geolocator = Nominatim(user_agent="location_app")  # Initialize geocoder
    location = geolocator.geocode(city)  # Get coordinates from city name

    if not location:
        print("âŒ Location not found.")
        return

    # Extract latitude and longitude
    center_lat, center_lng = location.latitude, location.longitude

    # Create a base map centered at the city
    traffic_map = folium.Map(location=[center_lat, center_lng], zoom_start=14)

    print("ğŸ“¡ Getting traffic light data...")
    lights = get_traffic_light_nodes(center_lat, center_lng)

    if not lights:
        print("âš ï¸ No traffic lights found.")
        return

    # Plot up to 10 traffic light markers
    for i, (lat, lng) in enumerate(lights[:10]):
        current_speed, free_flow_speed, congestion = get_traffic_flow(lat, lng)
        if current_speed is not None:
            light_text, color = get_light_status(congestion)
            tooltip = (
                f"ğŸš¦ Traffic Light {i+1}\n"
                f"Speed: {current_speed:.1f} / {free_flow_speed:.1f} km/h\n"
                f"Congestion: {congestion:.2f}\n"
                f"{light_text}"
            )
            # Add a colored circle marker for each light
            folium.CircleMarker(
                location=[lat, lng],
                radius=10,
                color=color,
                fill=True,
                fill_opacity=0.8,
                tooltip=tooltip
            ).add_to(traffic_map)

    # Save the map as HTML
    filename = "traffic_map.html"
    traffic_map.save(filename)
    print(f"âœ… Map saved as '{filename}'")

    # Automatically open the map in a browser
    webbrowser.open(filename)

# â–¶ï¸ Main entry point
if __name__ == "__main__":
    city_input = input("Enter a city name: ")  # Ask user for input
    create_real_traffic_light_map(city_input)  # Generate map
